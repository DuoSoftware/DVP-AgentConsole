/** * Created by Damith on 1/18/2017. */agentApp.directive('chatTabDirective', function ($rootScope, chatService) {    return {        restrict: "EA",        scope: {            chatUser: "=",            selectedChatUser: "=",            loginName: "=",            loginAvatar: "="        },        templateUrl: 'app/views/chat/chat-view.html',        link: function (scope, ele, attr) {            scope.chatTxt = null;            scope.chatUser.chatcount = 0;            scope.chatUser.isChatLoding = false;            scope.chatUser.windowMimOption = true;            scope.chatUser.postion = 0;            //get chat body scroll event            var minimuChatWidnow = function (currentChtW) {                $('#' + currentChtW.username).animate({                    bottom: "-350"                }, 300);                scope.chatUser.windowMimOption = false;            };            var maximuChatWindow = function (currentChtW) {                $('#' + currentChtW.username).animate({                    bottom: "0"                }, 300);                scope.chatUser.windowMimOption = true;                $('#' + currentChtW.username + " .cht-header").removeClass('rec-new-msg-blink');                ////////////////////////////////////////////////////////////////////////////////////                var pendingMessages = scope.messageThread.filter(function(item){                    return item.status == 'delivered';                })                if(pendingMessages && Array.isArray(pendingMessages))                pendingMessages.forEach(function(msg){                    SE.seen({to: scope.chatUser.username, id: msg.id});                });                /////////////////////////////////////////////////////////////////////////////////////////            };            var msgBodyScrollFun = function () {                return {                    getDivId: function () {                        return scope.chatUser._id;                    },                    goToScrollDown: function () {                        var objDiv = document.getElementById(scope.chatUser._id);                        objDiv.scrollTop = objDiv.scrollHeight;                    },                    goToNewMsgScroller: function (msg) {                        var objDiv = document.getElementById(msg._id);                        $('#' + msg._id).animate({scrollTop: div_terms.top}, "slow");                    }                }            }();            // //UI function            var chatWindowPosition = function () {                if (scope.selectedChatUser.length == 1) {                    //$('#' + scope.chatUser.username).setAttribute("style", "left:" + 18 + "%");                }            };            chatWindowPosition();            chatService.SubscribeChat(scope.chatUser.username, function (type, message) {                switch (type) {                    case 'message':                        //msgBodyScrollFun.goToNewMsgScroller(message);                        if (!scope.chatUser.windowMimOption) {                            $('#' + scope.chatUser.username + " .cht-header").addClass('rec-new-msg-blink');                            message.status = 'delivered';                        }else{                            SE.seen({to: scope.chatUser.username, id: message.id});                            message.status = 'seen';                        }                        scope.messageThread.push(message);                        break;                    case 'typing':                        scope.chatUser.typing = true;                        break;                    case 'typingstoped':                        scope.chatUser.typing = false;                        break;                    case 'seen':                        console.log(message);                        var seenMess = scope.messageThread.filter(function (mes) {                            return mes.id == message.id;                        });                        if (Array.isArray(seenMess)) {                            seenMess.forEach(function (seeM) {                                ///var status = 'notdelivered'                                seeM.status = message.status;                            });                        }                        break;                    case 'latestmessages':                        scope.chatUser.isChatLoding = true;                        scope.messageThread = [];                        message.messages.forEach(function (message) {                            message.message = message.data;                            message.id = message.uuid;                            scope.messageThread.push(message);                            if (message.status != 'seen' && message.from == scope.chatUser.username) {                                SE.seen({to: scope.chatUser.username, id: message.uuid});                            }                        });                        scope.chatUser.isChatLoding = false;                        msgBodyScrollFun.goToScrollDown();                        break;                }            });            chatService.Request('latestmessages', scope.chatUser.username);            scope.messageThread = [];            //user on type            scope.onFocusChat = function (val) {                SE.typing({to: scope.chatUser.username, from: scope.loginName});            };            scope.onFocusOutChat = function (val) {                SE.typingstoped({to: scope.chatUser.username, from: scope.loginName});            };            var sendMessage = function (user, msg) {                if (user) {                    var message = {'to': user.username, 'message': msg, 'type': "text"};                    var ms = SE.sendmessage(message);                    scope.messageThread.push(ms);                    scope.chatTxt = null;                }            };            scope.onKeyPressed = function ($event, user, msg) {                var keyCode = $event.which || $event.keyCode;                if (keyCode === 13) {                    sendMessage(user, msg);                }            };            //chat window option ------            scope.closeThisChat = function (currentChtW) {                console.log();                console.log(scope.selectedChatUser);                $('#' + currentChtW.username).animate({                    bottom: "-390"                });                chatService.DelChatUser(currentChtW.username);            };            scope.minimusChatW = function (currentChtW) {                minimuChatWidnow(currentChtW);            };            scope.maximusChatW = function (currentChtW) {                maximuChatWindow(currentChtW);            };            scope.$on('$destroy', function() {                console.log("destroy ");            });        }    }}).directive('enterSendChat', function () {    return function (scope, element, attrs) {        element.bind("keydown keypress", function (event) {            if (event.which === 13) {                scope.$apply(function () {                    scope.$eval(attrs.myEnter);                });                event.preventDefault();            }        });    };});